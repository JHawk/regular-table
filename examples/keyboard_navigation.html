<!--
   
   Copyright (c) 2020, the Regular Table Authors.
   
   This file is part of the Regular Table library, distributed under the terms of
   the Apache License 2.0.  The full license can be found in the LICENSE file.

-->

<!--

    Explanation
    
-->

<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <script src="../dist/umd/regular-table.js"></script>
    <link rel='stylesheet' href="../dist/css/material.css">
    <style>
        td {
            outline: none;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            min-width: 22px;
        }
        tbody th {
            border-right: 1px solid #eee;
        }
    </style>
</head>

<body>

    <regular-table></regular-table>

    <script>
        // Data Model
        window.DATA = Array.from(Array(78).fill()).map(() => Array(100).fill());

        window.DATA_COLUMN_NAMES = (() => {
            const caps = Array.from(Array(26)).map((val, i) => String.fromCharCode(i + 65));
            return caps.concat(
                caps.map((letter) => letter + letter),
                caps.map((letter) => letter + letter + letter)
            );
        })();

        window.dataListener = function(x0, y0, x1, y1) {
            return {
                num_rows,
                num_columns,
                row_headers: Array.from(Array(Math.ceil(y1) - y0).keys()).map((y) => [`${y + y0}`]),
                column_headers: window.DATA_COLUMN_NAMES.slice(x0, x1).map((x) => [x]),
                data: window.DATA.slice(x0, x1).map((col) => col.slice(y0, y1)),
            };
        }

    </script>


    <script>
        
    const table = document.getElementsByTagName("regular-table")[0];
    const num_rows = window.DATA[0].length;
    const num_columns = window.DATA.length;

    let xIndex = 0;
    let yIndex = 0;
    
    // TODO - this shouldn't be!
    const scrollRightStep = 3;
    function step(active_cell, x, y) {
        const meta = table.getMeta(active_cell);

        // new coordinates to focus
        if (meta.x + x < num_columns && 0 <= meta.x + x) {
            xIndex = meta.x + x;
        }
        if (meta.y + y < num_rows && 0 <= meta.y + y) {
            yIndex = meta.y + y;
        }

        // scroll x axis if necessary
        const columns = table.querySelectorAll("regular-table tbody tr:first-child td");
        if (meta.x0 + columns.length <= xIndex) {
            table.scrollTo(meta.x0 + scrollRightStep, meta.y0, num_columns, num_rows);
        } else if (xIndex < meta.x0 && 0 < meta.x0 - 1) {
            table.scrollTo(meta.x0 - 1,  meta.y0, num_columns, num_rows);
        }

        // scroll y axis if necessary
        const rows = table.querySelectorAll("regular-table tbody tr");
        if (meta.y0 + rows.length <= yIndex) {
            table.scrollTo(meta.x0, meta.y0 + 1, num_columns, num_rows);
        } else if (yIndex < meta.y0 && 0 < meta.y0 - 1) {
            table.scrollTo(meta.x0, meta.y0 - 1, num_columns, num_rows);
        }

        // ensure redraw
        table.draw();
    }

    table.setDataListener(window.dataListener);

    table.addStyleListener(() => {
        for (const td of table.get_tds()) {
            td.setAttribute("contenteditable", true);
            const meta = table.getMeta(td);
            if (meta.x === xIndex && meta.y === yIndex) {
                td.focus();
            } else {
                td.blur();
            }
        }
    });

    table.addEventListener("keydown", (event) => {
        const target = document.activeElement;
        switch (event.keyCode) {
            // left arrow
            case 37:
                step(target, -1, 0);
                break;
            // up arrow
            case 38:
                step(target, 0, -1);
                break;
            // right arrow
            case 39:
                step(target, 1, 0);
                break;
            // down arrow
            case 40:
                step(target, 0, 1);
                break;
        }
    });
    table.draw();
    </script>
</body>

</html>